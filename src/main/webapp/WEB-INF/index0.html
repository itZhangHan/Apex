
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>游戏页面</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-
	    scale=1,maximum-scale=1,user-scalable=no">
<script src="../js/webSocket.js"></script>
<script src="../js/userInfo.js"></script>
<script src="../js/jquery-2.1.1.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<link rel="stylesheet" href="../css/hall.css">
</head>
<body>

	<div class="centainer">
		<div class="room">
			<span id="roomID"></span> <img id="iconBtn" src="../img/iconBtn.png">
		</div>
		<!-- 背景音乐 -->
		<div class="item_btn">
			<ul>
				<li><img id="item1" src="../img/music.png"></li>
			</ul>
		</div>
		<!-- 座位 -->
		<div class="player_btn">
			<!-- 开始游戏 -->
			<div class="game_go">
				<img id="game_go" onclick="startGame()" src="../img/play/begin.png">
			</div>
			<ul class="sit">
				<li class="sit1" id="player1" value=""><img id="headImg1"
					src=""></li>
				<li class="sit2" id="player2" value=""><img id="headImg2"
					src=" "></li>
				<li class="sit3" id="player3" value=""><img id="headImg3"
					src=" "></li>
				<li class="sit4" id="player4" value=""><img id="headImg4"
					src=" "></li>
			</ul>
		</div>

		<div class="icon-player">
			<ul>
				<li id="icon1"><span id="orPrepare1" style="color: gold">
				</span><img id="img1" src=" "></li>
				<li id="icon2"><span id="orPrepare2" style="color: gold">
				</span> <img id="img2" src=" "></li>
				<li id="icon3"><span id="orPrepare3" style="color: gold">
				</span><img id="img3" src=" "></li>
				<li id="icon4"><span id="orPrepare4" style="color: gold">
				</span><img id="img4" src=" "></li>
				<li id="icon5"><span id="orPrepare5" style="color: gold">
				</span><img id="img5"></li>
				<li id="icon6"><span id="orPrepare6" style="color: gold">
				</span><img id="img6"></li>
				<li id="icon7"><span id="orPrepare7" style="color: gold">
				</span><img id="img7"></li>
				<li id="icon8"><span id="orPrepare8" style="color: gold">
				</span><img id="img8"></li>
			</ul>
		</div>
		<div class="chatRoom" id="chatRoom">

			<!-- <img class="slh" src="../img/play/slh.png"> -->
		</div>
		<div class="ele">
			<input id="sendTxt_0" type="text" maxlength="25" />
			<button id="sendBtn_0">
				<img src="../img/sendBtn.png">
			</button>
		</div>

	</div>

	<script type="text/javascript">
		var ownerImg = "";
		//页面加载前发送给服务端的数据
		var imagelist = "";
		window.onload = function usmessage() {
			//邀请好友
			var iconBtn = document.getElementById("iconBtn");
			iconBtn.onclick = function() {
				document.location = "http://thdd.apexgame.cn/tetris/skip/first";
			}
			//判断当前用户是否属于房主  如果不是房主 不给于开始游戏的 权限 并显示房主名字	
			//删除房间逻辑判断 此处需要 增加

			var userMessage = {};
			userMessage.type = "usmesage"
			userMessage.roomId = roomId;
			userMessage.toUserName = "";
			userMessage.fromUserName = "";
			userMessage.msgStr = "";
			userMessage.userStatus = userStatus;
			userMessage.roomState = roomState;
			userMessage.position = "1";
			userMessage.headimgurl = img;
			userMessage.nicakname = nicakname;
			userMessage.sex = sex;
			userMessage.city = city;
			userMessage.userId = userId;
			userMessage.props = "";
			userMessage.isSelf = "";
			userMessage.getOnclient = "";
			userMessage.ownerImg = "";
			userMessage.imgOne = "";
			userMessage.imgTwo = "";
			userMessage.imgThree = "";
			userMessage.imgFour = "";
			websocket.send(JSON.stringify(userMessage));
		}

		function startGame() {
			if (userStatus == 0) {
				var gameMessage = {};
				gameMessage.type = "roomStatus"
				gameMessage.roomId = roomId;
				gameMessage.toUserName = "";
				gameMessage.fromUserName = "";
				gameMessage.msgStr = "";
				gameMessage.userStatus = userStatus;
				gameMessage.roomState = roomState;
				gameMessage.position = "1";
				gameMessage.headimgurl = img;
				gameMessage.nicakname = nicakname;
				gameMessage.sex = sex;
				gameMessage.city = city;
				gameMessage.userId = userId;
				gameMessage.props = "";
				gameMessage.isSelf = "";
				gameMessage.getOnclient = "";
				gameMessage.ownerImg = "";
				websocket.send(JSON.stringify(gameMessage));

				/* var gameGo = document.getElementById("game_go");
				var gameGo = document.getElementById("game_go");
				var play_go = document.getElementById("play_go");
					gameGo.onclick = function(){
					play_go.style.display = "block"; */
			} else {
				alert("别动")
			}

		}
		//旁观者
		var headUrl0 = document.getElementById("img1");
		var headUrl1 = document.getElementById("img2");
		var headUrl2 = document.getElementById("img3");
		var headUrl3 = document.getElementById("img4");
		var headUrl4 = document.getElementById("img5");
		var headUrl5 = document.getElementById("img6");
		var headUrl6 = document.getElementById("img7");
		var headUrl7 = document.getElementById("img8");

		//玩家
		var head1 = document.getElementById("headImg1");
		var head2 = document.getElementById("headImg2");
		var head3 = document.getElementById("headImg3");
		var head4 = document.getElementById("headImg4");

		//已准备定义 
		var span1 = document.getElementById("orPrepare1");
		var span2 = document.getElementById("orPrepare2");
		var span3 = document.getElementById("orPrepare3");
		var span4 = document.getElementById("orPrepare4");
		var span5 = document.getElementById("orPrepare5");
		var span6 = document.getElementById("orPrepare6");
		var span7 = document.getElementById("orPrepare7");
		var span8 = document.getElementById("orPrepare8");

		//延迟调用 判断房间总人数
		function timer() {

			if (userStatus == 0) {
				alert("房主退出")
			}

			setTimeout("timer( )", 1000)
		}

		var wanjia2 = document.getElementById("player2");
		wanjia2.onclick = function() {

			//userStatus 当前用户  0房主  1玩家  2旁观者
			if (userStatus == 0) {
				alert("房主不能换座");
				return false;
			}

			//第二个位置 信息
			var userId1 = wanjia2.value;

			if (userId1 == '') {
				//	f2 = true;
				showUpHeader("down", 2);

			} else {
				//位置有人  起立 
				if (userId1 == userId) {

					showUpHeader("up", 2);

				} else {
					alert("请安心坐在自己位置上！");
				}
			}
		}
		var wanjia3 = document.getElementById("player3");
		wanjia3.onclick = function() {
			if (userStatus == 0) {

				alert("房主不能换座");
				return false;
			}
			var userId3 = wanjia3.value;
			if (userId3 == '') {
				//	f2 = true;
				showUpHeader("down", 3);
			} else {
				//位置有人
				if (userId3 == userId) {
					showUpHeader("up", 3);
				} else {
					alert("请安心坐在自己位置上！");
				}
			}
		}
		var wanjia4 = document.getElementById("player4");
		wanjia4.onclick = function() {
			if (userStatus == 0) {
				alert("房主不能换座");
				return false;
			}
			var userId4 = wanjia4.value;
			if (userId4 == '') {
				//	f2 = true;
				showUpHeader("down", 4);
			} else {
				//位置有人
				if (userId4 == userId) {
					showUpHeader("up", 4);
				} else {
					alert("别动！");
				}
			}
		}

		//聊天通信模块

		document.getElementById("sendBtn_0").onclick = function() {
			var txt = document.getElementById("sendTxt_0").value;
			div_2 = document.getElementById("chatRoom");
			div_2.style.overflowY = "scroll";
			document.getElementById("sendTxt_0").value = "";
			var mes = {};
			mes.type = "message";
			mes.msgStr = txt;
			mes.roomId = roomId;
			mes.toUserName = ""
			mes.fromUserName = "";
			mes.userStatus = userStatus;
			mes.roomState = roomState;
			mes.roomName = roomName;
			mes.position = ""
			mes.headimgurl = img;
			mes.nicakname = nicakname;
			mes.city = city;
			mes.sex = sex;
			mes.userId = userId;
			mes.props = "";
			mes.isSelf = "";
			mes.getOnclient = "";
			mes.ownerImg = "";
			websocket.send(JSON.stringify(mes));
		}
		//接收起立type 展示数据
		function showUpmessage(b) {

			if (b.position == '2') {
				//var head2 = document.getElementById("headImg2");
				//透明图片
				head2.src = '../img/play/logo.jpg';
				//orPrepare2.innerHTML = "";
				wanjia2.value = '';

			} else if (b.position == '3') {
				head3.src = '../img/play/logo.jpg';
				//orPrepare3.innerHTML = ""
				wanjia3.value = '';
			} else if (b.position == '4') {
				head4.src = '../img/play/logo.jpg';
				//orPrepare4.innerHTML = ""
				wanjia4.value = '';
			}
			imagelist="";
			var hd1src = document.getElementById("headImg1").src;
			var hd2src = document.getElementById("headImg2").src;
			var hd3src = document.getElementById("headImg3").src;
			var hd4src = document.getElementById("headImg4").src;
				//var imagelist=""
		   if (hd1src.indexOf("index0send")<0 && hd1src.indexOf("joinRoomSend")<0) {
				imagelist = imagelist+hd1src;
				
			}  
		   if (hd2src.indexOf("index0send")<0 && hd2src.indexOf("joinRoomSend")<0) {
				imagelist = imagelist+hd2src;
				//alert("2"+head2.src+":"+imagelist);
			} 
		   if (hd3src.indexOf("index0send")<0 && hd3src.indexOf("joinRoomSend")<0) {
				imagelist = imagelist+hd3src;
				//alert("3"+head3.src+":"+imagelist);
			} 
		   if (hd4src.indexOf("index0send")<0 && hd4src.indexOf("joinRoomSend")<0) {
				imagelist = "4"+imagelist+hd4src;
				//alert("4"+head4.src+":"+imagelist);
			} 
			var zuowei = b.position;
			for (var i = 1; i <= 4; i++) {
				var headImage = document.getElementById("headImg" + i);
				var player = document.getElementById("player" + i);
				if (i != zuowei) {
					//alert(headImage.src+"+")

					if (headImage.src == b.headimgurl) {
						headImage.src = '../img/play/touming.jpg';
						player.value = '';
					}

					//alert("22222"+headImage.src);
				}

			}
			for (var z = 1; z <= 8; z++) {

				var teas111 = document.getElementById("img" + z);

				if (imagelist.indexOf(teas111.src) > -1 && teas111.src != "") {
					document.getElementById("orPrepare" + z).innerHTML = "已准备";
				} else {
					document.getElementById("orPrepare" + z).innerHTML = "";
				}
				if (ownerImg == teas111.src) {
					document.getElementById("orPrepare1").innerHTML = "";
				}
			}

		}
		function showChangeSeat(b) {

			//清除之前位置头像
			if (b.msgStr == "server同意交换") {
				//如果允许坐下 
				if (b.position == '2') {
					//给位置填充图片
					head2.src = b.headimgurl;
					//修改旁观者信息为 已准备

					//设置头像value为userid
					wanjia2.value = b.userId;
					//遍历头像 设置之前头像消失

				} else if (b.position == '3') {
					head3.src = b.headimgurl;

					wanjia3.value = b.userId;
					//遍历头像 设置之前头像消失
				} else if (b.position == '4') {
					head4.src = b.headimgurl;

					wanjia4.value = b.userId;
					//遍历头像 设置之前头像消失
				}
			}
		}
		//接收坐下type 展示数据
		function showDownmessage(b) {
			var sitUl = document.getElementsByClassName("sit");
		
			if (b.position == '1') {
				//给位置填充图片
				head2.src = b.imgOne;
				//修改旁观者信息为 已准备
				/* orPrepare2.innerHTML = "已准备";  */
				//设置头像value为userid
				wanjia2.value = b.userId;
				//遍历头像 设置之前头像消失

			} 
			if (b.position == '2') {
				//给位置填充图片
				head2.src = b.imgTwo;
				//修改旁观者信息为 已准备
				/* orPrepare2.innerHTML = "已准备";  */
				//设置头像value为userid
				wanjia2.value = b.userId;
				//遍历头像 设置之前头像消失

			} else if (b.position == '3') {
				head3.src = b.imgThree;
				//orPrepare3.innerHTML = "已准备"; 
				wanjia3.value = b.userId;
				//遍历头像 设置之前头像消失
			} else if (b.position == '4') {
				head4.src = b.imgFour;
				//orPrepare4.innerHTML = "已准备";  
				wanjia4.value = b.userId;
				//遍历头像 设置之前头像消失
			}
			
			imagelist="";
			var hd1src = document.getElementById("headImg1").src;
			var hd2src = document.getElementById("headImg2").src;
			var hd3src = document.getElementById("headImg3").src;
			var hd4src = document.getElementById("headImg4").src;
				//var imagelist=""
		   if (hd1src.indexOf("index0send")<0 && hd1src.indexOf("joinRoomSend")<0) {
				imagelist = imagelist+hd1src;
				
			}  
		   if (hd2src.indexOf("index0send")<0 && hd2src.indexOf("joinRoomSend")<0) {
				imagelist = imagelist+hd2src;
				//alert("2"+head2.src+":"+imagelist);
			} 
		   if (hd3src.indexOf("index0send")<0 && hd3src.indexOf("joinRoomSend")<0) {
				imagelist = imagelist+hd3src;
				//alert("3"+head3.src+":"+imagelist);
			} 
		   if (hd4src.indexOf("index0send")<0 && hd4src.indexOf("joinRoomSend")<0) {
				imagelist = "4"+imagelist+hd4src;
				//alert("4"+head4.src+":"+imagelist);
			} 
			
			//清理原来座位
			var zuowei = b.position;
			for (var i = 1; i <= 4; i++) {
				var headImage = document.getElementById("headImg" + i);
				var player = document.getElementById("player" + i);
				if (i != zuowei) {
					//alert(headImage.src+"+")		
					if (headImage.src == b.headimgurl) {
						headImage.src = '../img/play/touming.jpg';
						player.value = '';
					}
					//alert("22222"+headImage.src);
				}
			}
			//四人座位src 
			//var piclisti=head1.src+","+head2.src+","+head3.src+","+head4.src;
			//orPrepare3orPrepare3orPrepare3orPrepare3orPrepare3orPrepare3orPrepare3orPrepare3orPrepare3
			for (var z = 1; z <= 8; z++) {

				var teas111 = document.getElementById("img" + z);

				if (imagelist.indexOf(teas111.src) > -1 && teas111.src != "") {
					document.getElementById("orPrepare" + z).innerHTML = "已准备";
				} else {
					document.getElementById("orPrepare" + z).innerHTML = "";
				}
				if (ownerImg == teas111.src) {

					document.getElementById("orPrepare1").innerHTML = "";
				}

			}

		}
		//接收游戏类型 设置游戏开始
		function actionGame(b) {
			//当接收到返回房间状态为1时候跳转到开始游戏界面
			if (b.roomState == 1) {
				//当房间状态为1时候判断玩家状态
				//将玩家状态为1(准备玩家)的玩家跳转到游戏页面
				//其余旁观者不予改变
				if (b.socketUser.status == 0) {

					document.location = "http://thdd.apexgame.cn/tetris/skip/indexsend?userName="
							+ b.nickName
							+ "&roomStatus="
							+ b.roomState
							+ "&roomId="
							+ b.roomId
							+ "&userStatus="
							+ b.userStatus + "&headImg=" + b.headimgurl;

				}
			} else {
				document.location = "http://thdd.apexgame.cn/tetris/skip/index0send";
			}
		}
		//显示分数信息
		function showScore(b) {

		}

		//接收房间所有信息，展示用户信息
		function showMessage(b) {

			var str = b.msgStr;
			var imgSock = b.headimgurl;
			var nicakname = b.nickName;
			var div_3 = document.createElement("div");
			div_3.style.fontSize = "20px";
			div_3.style.wordBreak = "break-all"
			div_3.style.marginTop = "1px";
			div_3.style.dispaly = "block";
			var ss = 7;
			//b.isSelf == "1"
			if (b.userId == userId) {
				//本人
				div_3.innerHTML += "<li style='clear:both;font-size:20px'>"
						+ "<div><img class='imgright' src='"+imgSock+"'></div>"
						+ "<div  class='sockitnamer'>"
						+ "<h2  style='font-size:11px'class='hostName nameRight'>"
						+ nicakname + "</h2>"
						+ "<p style='font-size:11px;' class='nameB' >" + str
						+ "</p>" + "</div>" + "</li>"
			} else {
				//别人 2s
				div_3.innerHTML += "<li style='clear:both;font-size:20px'>"
						+ "<img class='imgleft' src='"+imgSock+"'>" + "</div>"
						+ "<div class='sockitnamel'>"
						+ "<h2  style='font-size:11px'class='hostName'>"
						+ nicakname + "</h2>" + "<p style='font-size:11px;'>"
						+ str + "</p>" + "</div>" + "</li>"
			}

			div_2.appendChild(div_3)
			div_2.scrollTop = div_2.scrollHeight;

		}
		//房主名字

		websocket.onmessage = function(e) {
			var jsonObj = eval("(" + e.data + ")");
			console.log(jsonObj)
			var b = JSON.parse(jsonObj);
			//var nowImgs = b.listImgs;
			//alert(nowImgs[0].nowImg+"==这些！");
			//var returnLists = b.listImgs;
			//房主头像
			ownerImg = b.ownerImg;
			alert("位置一的头像="+b.imgOne+"，位置二的头像="+b.imgTwo+"，位置三的头像="+b.imgThree+"，位置四的头像="+b.imgFour);
		/* 	var shuzu = b.playerImgs;
			alert("数组0："+shuzu[0]);
			alert("数组1："+shuzu[1]);
			alert("数组2："+shuzu[2]);
			alert("数组4："+shuzu[3]); */
			//imagelist = "";
			//for (var a = 0; a < returnLists.length; a++) {
			//图片数组 
			/* imagelist = imagelist + returnLists[a].nowImg
					+ "@@@@@@@@@@@@@@@" + a; */
			//imagelist = imagelist + b.headimgurl
			//+ "@@@@@@@@@@@@@@@" + a;
			//}
			//alert("集合头像："+imagelist);
			if (b.type == 'usmesage') {

				var gameDom = document.getElementById("game_go");
				gameDom.style.display = "none";

				var openRoom = document.getElementById("roomID");
				openRoom.innerText = b.roomName;
				//var openRoom = document.getElementById("roomID");
				//显示旁观者信息
				showHeadImg(b.listUsers);
				showUserList(b.listUsers);

			}
			//允许换做 给将要坐的位置填充图片
			if (b.type == 'changeSeat') {
				showChangeSeat(b);
			}
			if (b.type == 'message') {
				//展示发送消息数据
				showMessage(b);
			}
			if (b.type == 'up') {
				//展示起立信息
				showUpmessage(b);
			}
			if (b.type == 'down') {
				//展示坐下信息
				showDownmessage(b);

			}
			if (b.type == 'roomStatus') {
				//展示游戏开始数据
				actionGame(b);
			}
			if (b.type == 'score') {
				//展示分数信息
				showScore(b);
			}
		}

		//显示旁观者信息
		function showUserList(listUsers) {
			for (var i = 0; i < listUsers.length; i++) {

				document.getElementById("img" + (i + 1)).src = listUsers[i].userportrait;

			}
		}

		function showHeadImg(listUsers) {
			for (var i = 0; i < listUsers.length; i++) {
				if (listUsers[i].status == 0) {
					headImg1.src = listUsers[i].userportrait;
					headImg1.onclick = function() {
						alert("你是房主！");
					}
				}
				if (listUsers[i].status == 1) {
					if (listUsers[i].headPostion == 1)
						headImg1.src = listUsers[i].userportrait;
					if (listUsers[i].headPostion == 2)
						headImg2.src = listUsers[i].userportrait;
					if (listUsers[i].headPostion == 3)
						headImg3.src = listUsers[i].userportrait;
					if (listUsers[i].headPostion == 4)
						headImg4.src = listUsers[i].userportrait;
				}
			}
		}

		function showUpHeader(ud, position) {
			var upDown = {};
			upDown.type = ud;
			upDown.roomId = roomId;
			upDown.toUserName = "2";
			upDown.fromUserName = " ";
			upDown.msgStr = "";
			upDown.userStatus = userStatus;
			upDown.roomState = roomState;
			upDown.position = position
			upDown.headimgurl = img;
			upDown.nicakname = nicakname;
			upDown.sex = sex;
			upDown.city = city;
			upDown.userId = userId;
			upDown.props = "";
			upDown.isSelf = "";
			upDown.getOnclient = "";
			upDown.ownerImg = "";
			upDown.imgOne = "";
			upDown.imgTwo = "";
			upDown.imgThree = "";
			upDown.imgFour = "";
			websocket.send(JSON.stringify(upDown));
		}

		document.getElementById("sendBtn_0").onclick = function() {
			var txt = document.getElementById("sendTxt_0").value;
			div_2 = document.getElementById("chatRoom");
			div_2.style.overflowY = "scroll";//auto    scroll						
			document.getElementById("sendTxt_0").value = "";
			var mes = {};
			mes.type = "message";
			mes.msgStr = txt;
			mes.roomId = roomId;
			mes.toUserName = ""
			mes.fromUserName = "";
			mes.userStatus = userStatus;
			mes.roomState = roomState;
			mes.roomName = roomName;
			mes.position = ""
			mes.headimgurl = img;
			mes.nicakname = nicakname;
			mes.city = city;
			mes.sex = sex;
			mes.userId = userId;
			mes.props = "";
			mes.isSelf = "";
			mes.getOnclient = "";
			mes.ownerImg = "";
			websocket.send(JSON.stringify(mes));
		}
		function sendUsers() {

			var readingUsers = {};
			readingUsers.type = "gameUsmessage"
			readingUsers.roomId = "1001";
			readingUsers.toUserName = "";
			readingUsers.fromUserName = "";
			readingUsers.msgStr = "";
			readingUsers.userStatus = "0";
			readingUsers.roomState = "1";
			readingUsers.position = "";
			readingUsers.headimgurl = "";
			readingUsers.nicakname = "zhangsan";
			readingUsers.sex = "1";
			readingUsers.city = "beijing";
			readingUsers.userId = "50";
			readingUsers.props = "道具";
			readingUsers.isSelf = "";
			readingUsers.getOnclient = "";
			readingUsers.ownerImg = "";
			websocket.send(JSON.stringify(readingUsers));

		}
	</script>

</body>
</html>